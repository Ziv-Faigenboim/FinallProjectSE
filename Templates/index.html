{% extends "base.html" %}

{% block title %}Sensor Map{% endblock %}

{% block content %}
<style>
  #map-container {
    position: relative;
    height: 100%;
    width: 100%;
  }
  #map {
    height: 500px;
    width: 100%;
  }
  .button {
    padding: 10px 15px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 10px;
  }
  .gradient-meter {
    width: 100%;
    height: 10px;
    background: linear-gradient(to right, #ccc, #007bff);
    position: relative;
    border-radius: 5px;
    margin-top: 5px;
  }
  .meter-indicator {
    position: absolute;
    top: -5px;
    width: 10px;
    height: 20px;
    background: red;
    border-radius: 2px;
  }
  #slider-container {
    padding: 10px;
    background: #fff;
    margin-top: 10px;
  }
  #sun-icon {
    font-size: 24px;
    margin-left: 0%;
  }
</style>

<div class="container">
  <div id="sensor-panel">
    <h2>Sensor Data</h2>
    <div id="sensor-data-container">
      <p>Click the sensor marker on the map to load data.</p>
    </div>
    <button id="history-button" class="button">Show History</button>
    <div id="history-container" style="display: none;">
      <h3>Historical Data</h3>
      <ul id="history-list"></ul>
    </div>
    <button id="toggle-3d" class="button">Toggle 3D Buildings</button>
  </div>

  <div id="map-container">
    <div id="map"></div>
    <div id="slider-container">
      <input type="range" id="time-slider" min="0" max="23" value="12" step="1">
      <div id="sun-icon">☀️</div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/OSMBuildings.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let osmb;
  let buildingsVisible = true;

  const markerElement = document.createElement('div');
  markerElement.style.width = '20px';
  markerElement.style.height = '20px';
  markerElement.style.background = 'red';
  markerElement.style.border = '2px solid white';
  markerElement.style.borderRadius = '50%';
  markerElement.style.cursor = 'pointer';

  function createMap() {
    const mapContainer = document.getElementById('map');
    mapContainer.innerHTML = ''; // clean map div before re-init
    const newMap = document.createElement('div');
    newMap.id = 'map';
    mapContainer.appendChild(newMap);

    osmb = new OSMBuildings({
      container: 'map',
      position: { latitude: 31.252973, longitude: 34.791462 },
      zoom: 17,
      minZoom: 15,
      maxZoom: 20
    });

    osmb.addMapTiles(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution: '© OpenStreetMap contributors', maxZoom: 19 }
    );

    if (buildingsVisible) {
      osmb.addGeoJSONTiles(
        'https://data.osmbuildings.org/0.2/anonymous/tile/{z}/{x}/{y}.json'
      );
    }

    osmb.addMarker({
      id: 'sensor',
      coordinates: [34.791462, 31.252973],
      element: markerElement
    });
  }

  createMap();

  document.getElementById('toggle-3d').addEventListener('click', () => {
    buildingsVisible = !buildingsVisible;
    createMap(); // Recreate map with or without buildings
  });

  markerElement.addEventListener('click', async () => {
    try {
      const response = await fetch('/get-sensor-data');
      const data = await response.json();
      const quality = Math.min(100, Math.max(0, (data.humidity * 0.6 + (30 - data.temperature) * 2)));

      document.getElementById('sensor-data-container').innerHTML = `
        <h3>Live Sensor Readings</h3>
        <p><strong>Temperature:</strong> ${data.temperature}°C</p>
        <p><strong>Humidity:</strong> ${data.humidity}%</p>
        <p><strong>Battery:</strong> ${data.battery}%</p>
        <p><strong>Sample Time:</strong> ${data.sample_time}</p>
        <p><strong>Shadow Quality:</strong></p>
        <div class="gradient-meter">
          <div class="meter-indicator" style="left: ${quality}%;"></div>
        </div>`;
    } catch (err) {
      console.error('Error fetching sensor data:', err);
    }
  });

  document.getElementById('history-button').addEventListener('click', async () => {
    const container = document.getElementById('history-container');
    container.style.display = container.style.display === 'none' ? 'block' : 'none';

    if (container.style.display === 'block') {
      const response = await fetch('/get-sensor-history');
      const data = await response.json();
      const list = document.getElementById('history-list');
      list.innerHTML = '';

      data.forEach(entry => {
        const li = document.createElement('li');
        li.innerHTML = `
          <strong>Temperature:</strong> ${entry.temperature} °C<br>
          <strong>Humidity:</strong> ${entry.humidity} %<br>
          <strong>Battery:</strong> ${entry.battery} %<br>
          <strong>Time:</strong> ${entry.sample_time}`;
        list.appendChild(li);
      });
    }
  });

  const slider = document.getElementById('time-slider');
  const sunIcon = document.getElementById('sun-icon');
  slider.addEventListener('input', function () {
    const percent = (slider.value / 23) * 100;
    sunIcon.style.marginLeft = percent + '%';
  });
});
</script>

{% endblock %}
