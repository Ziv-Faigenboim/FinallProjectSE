<<<<<<< Updated upstream
{% extends "base.html" %}

{% block title %}Sensor Map{% endblock %}

{% block content %}
<style>
  #map-container {
    position: relative;
    height: 100%;
    width: 100%;
  }
  #map {
    height: 500px;
    width: 100%;
  }
  .button {
    padding: 10px 15px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 10px;
  }
  .gradient-meter {
    width: 100%;
    height: 10px;
    background: linear-gradient(to right, #ccc, #007bff);
    position: relative;
    border-radius: 5px;
    margin-top: 5px;
  }
  .meter-indicator {
    position: absolute;
    top: -5px;
    width: 10px;
    height: 20px;
    background: red;
    border-radius: 2px;
  }
  #slider-container {
    padding: 10px;
    background: #fff;
    margin-top: 10px;
  }
  #sun-icon {
    font-size: 24px;
    margin-left: 0%;
  }
</style>

<div class="container">
  <div id="sensor-panel">
    <h2>Sensor Data</h2>
    <div id="sensor-data-container">
      <p>Click the sensor marker on the map to load data.</p>
    </div>
    <button id="history-button" class="button">Show History</button>
    <div id="history-container" style="display: none;">
      <h3>Historical Data</h3>
      <ul id="history-list"></ul>
    </div>
    <button id="toggle-3d" class="button">Toggle 3D Buildings</button>
  </div>

  <div id="map-container">
    <div id="map"></div>
    <div id="slider-container">
      <input type="range" id="time-slider" min="0" max="23" value="12" step="1">
      <div id="sun-icon">☀️</div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/OSMBuildings.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let osmb;
  let buildingsVisible = true;

  const markerElement = document.createElement('div');
  markerElement.style.width = '20px';
  markerElement.style.height = '20px';
  markerElement.style.background = 'red';
  markerElement.style.border = '2px solid white';
  markerElement.style.borderRadius = '50%';
  markerElement.style.cursor = 'pointer';

  function createMap() {
    const mapContainer = document.getElementById('map');
    mapContainer.innerHTML = ''; // clean map div before re-init
    const newMap = document.createElement('div');
    newMap.id = 'map';
    mapContainer.appendChild(newMap);

    osmb = new OSMBuildings({
      container: 'map',
      position: { latitude: 31.252973, longitude: 34.791462 },
      zoom: 17,
      minZoom: 15,
      maxZoom: 20
    });

    osmb.addMapTiles(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution: '© OpenStreetMap contributors', maxZoom: 19 }
    );

    if (buildingsVisible) {
      osmb.addGeoJSONTiles(
        'https://data.osmbuildings.org/0.2/anonymous/tile/{z}/{x}/{y}.json'
      );
    }

    osmb.addMarker({
      id: 'sensor',
      coordinates: [34.791462, 31.252973],
      element: markerElement
    });
  }

  createMap();

  document.getElementById('toggle-3d').addEventListener('click', () => {
    buildingsVisible = !buildingsVisible;
    createMap(); // Recreate map with or without buildings
  });

  markerElement.addEventListener('click', async () => {
    try {
      const response = await fetch('/get-sensor-data');
      const data = await response.json();
      const quality = Math.min(100, Math.max(0, (data.humidity * 0.6 + (30 - data.temperature) * 2)));

      document.getElementById('sensor-data-container').innerHTML = `
        <h3>Live Sensor Readings</h3>
        <p><strong>Temperature:</strong> ${data.temperature}°C</p>
        <p><strong>Humidity:</strong> ${data.humidity}%</p>
        <p><strong>Battery:</strong> ${data.battery}%</p>
        <p><strong>Sample Time:</strong> ${data.sample_time}</p>
        <p><strong>Shadow Quality:</strong></p>
        <div class="gradient-meter">
          <div class="meter-indicator" style="left: ${quality}%;"></div>
        </div>`;
    } catch (err) {
      console.error('Error fetching sensor data:', err);
    }
  });

  document.getElementById('history-button').addEventListener('click', async () => {
    const container = document.getElementById('history-container');
    container.style.display = container.style.display === 'none' ? 'block' : 'none';

    if (container.style.display === 'block') {
      const response = await fetch('/get-sensor-history');
      const data = await response.json();
      const list = document.getElementById('history-list');
      list.innerHTML = '';

      data.forEach(entry => {
        const li = document.createElement('li');
        li.innerHTML = `
          <strong>Temperature:</strong> ${entry.temperature} °C<br>
          <strong>Humidity:</strong> ${entry.humidity} %<br>
          <strong>Battery:</strong> ${entry.battery} %<br>
          <strong>Time:</strong> ${entry.sample_time}`;
        list.appendChild(li);
      });
    }
  });

  const slider = document.getElementById('time-slider');
  const sunIcon = document.getElementById('sun-icon');
  slider.addEventListener('input', function () {
    const percent = (slider.value / 23) * 100;
    sunIcon.style.marginLeft = percent + '%';
  });
});
</script>

{% endblock %}
=======
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapbox 2D/3D Toggle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Include Mapbox GL JS CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .toggle-button {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1;
      background: #fff;
      border: none;
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button class="toggle-button" id="toggle3d">3D Map</button>

  <!-- Include Mapbox GL JS library -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
    // Replace 'YOUR_MAPBOX_TOKEN_HERE' with your actual Mapbox access token.
    mapboxgl.accessToken = 'pk.eyJ1IjoiZWxhZDc2MTAiLCJhIjoiY205andvMnN2MDZpaDJqc2JvaXhlbWR2bCJ9.BL95xjSj5yW4y3Rb_0_l1w';

    // Initialize the map
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-74.0066, 40.7135], // New York City coordinates; adjust as needed
      zoom: 15,
      pitch: 0,     // start with a flat view
      bearing: 0
    });

    // Flag to track current view mode
    var is3D = false;

    // Function to add the 3D buildings layer
    function add3dLayer() {
      // Find the first symbol layer to ensure our 3D buildings layer is rendered beneath labels.
      var layers = map.getStyle().layers;
      var labelLayerId;
      for (var i = 0; i < layers.length; i++) {
        if (layers[i].type === 'symbol' && layers[i].layout && layers[i].layout['text-field']) {
          labelLayerId = layers[i].id;
          break;
        }
      }

      // Add 3D buildings layer if it doesn't already exist.
      if (!map.getLayer('3d-buildings')) {
        map.addLayer({
          'id': '3d-buildings',
          'source': 'composite',
          'source-layer': 'building',
          'filter': ['==', 'extrude', 'true'],
          'type': 'fill-extrusion',
          'minzoom': 15,
          'paint': {
            'fill-extrusion-color': '#aaa',
            'fill-extrusion-height': [
              'interpolate', ['linear'], ['zoom'],
              15, 0,
              15.05, ['get', 'height']
            ],
            'fill-extrusion-base': [
              'interpolate', ['linear'], ['zoom'],
              15, 0,
              15.05, ['get', 'min_height']
            ],
            'fill-extrusion-opacity': 0.6
          }
        }, labelLayerId);
      }
    }

    // Function to remove the 3D buildings layer
    function remove3dLayer() {
      if (map.getLayer('3d-buildings')) {
        map.removeLayer('3d-buildings');
      }
    }

    // Attach event listener to the toggle button
    document.getElementById('toggle3d').addEventListener('click', function() {
      if (is3D) {
        // Switch to 2D view: reset pitch and bearing and remove 3D layer.
        map.easeTo({ pitch: 0, bearing: 0 });
        remove3dLayer();
        is3D = false;
        this.textContent = "3D Map";
      } else {
        // Switch to 3D view: change camera settings and add 3D buildings.
        map.easeTo({ pitch: 60, bearing: -17.6 });
        add3dLayer();
        is3D = true;
        this.textContent = "2D Map";
      }
    });
  </script>
</body>
</html>
>>>>>>> Stashed changes
